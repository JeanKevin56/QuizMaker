<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Taking Demo</title>
    <link rel="stylesheet" href="../styles/main.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
        }
        
        .demo-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .demo-header {
            background: #2563eb;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .demo-content {
            padding: 20px;
        }
        
        .demo-controls {
            background: #f1f5f9;
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .demo-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .demo-button:hover {
            background: #2563eb;
        }
        
        .demo-button.secondary {
            background: #64748b;
        }
        
        .demo-button.secondary:hover {
            background: #475569;
        }
        
        .status-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .status-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        
        .status-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .status-value {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .quiz-container {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            min-height: 400px;
        }
        
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1>Quiz Taking Functionality Demo</h1>
            <p>Demonstrating QuizNavigator and AnswerCollector integration</p>
        </div>
        
        <div class="demo-content">
            <div id="status-panel" class="status-panel">
                <h3>Quiz Status</h3>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">Current Question</div>
                        <div class="status-value" id="current-question">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Answered</div>
                        <div class="status-value" id="answered-count">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Current Score</div>
                        <div class="status-value" id="current-score">-</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Completion</div>
                        <div class="status-value" id="completion">-</div>
                    </div>
                </div>
            </div>
            
            <div id="messages"></div>
            
            <div id="quiz-container" class="quiz-container">
                <!-- Quiz will be rendered here -->
            </div>
        </div>
        
        <div class="demo-controls">
            <button id="start-quiz" class="demo-button">Start Quiz</button>
            <button id="save-progress" class="demo-button secondary">Save Progress</button>
            <button id="load-progress" class="demo-button secondary">Load Progress</button>
            <button id="reset-quiz" class="demo-button secondary">Reset Quiz</button>
            <button id="show-answers" class="demo-button secondary">Show Current Answers</button>
        </div>
    </div>

    <script type="module">
        import { QuizNavigator } from '../components/QuizNavigator.js';
        import { QUESTION_TYPES } from '../models/types.js';

        // Sample quiz data
        const sampleQuiz = {
            id: 'demo-quiz-1',
            title: 'Demo Quiz: Web Development Basics',
            description: 'Test your knowledge of web development fundamentals',
            questions: [
                {
                    id: 'q1',
                    type: QUESTION_TYPES.MCQ_SINGLE,
                    question: 'What does HTML stand for?',
                    options: [
                        'Hyper Text Markup Language',
                        'High Tech Modern Language',
                        'Home Tool Markup Language',
                        'Hyperlink and Text Markup Language'
                    ],
                    correctAnswer: 0,
                    explanation: 'HTML stands for Hyper Text Markup Language, which is the standard markup language for creating web pages.'
                },
                {
                    id: 'q2',
                    type: QUESTION_TYPES.MCQ_MULTIPLE,
                    question: 'Which of the following are CSS properties for layout?',
                    options: [
                        'display',
                        'color',
                        'position',
                        'font-size',
                        'flex-direction'
                    ],
                    correctAnswers: [0, 2, 4],
                    explanation: 'display, position, and flex-direction are CSS properties that affect layout, while color and font-size affect styling.'
                },
                {
                    id: 'q3',
                    type: QUESTION_TYPES.TEXT_INPUT,
                    question: 'What JavaScript method is used to add an element to the end of an array?',
                    correctAnswer: 'push',
                    caseSensitive: false,
                    explanation: 'The push() method adds one or more elements to the end of an array and returns the new length of the array.'
                },
                {
                    id: 'q4',
                    type: QUESTION_TYPES.MCQ_SINGLE,
                    question: 'Which HTTP status code indicates a successful request?',
                    options: ['404', '500', '200', '301'],
                    correctAnswer: 2,
                    explanation: 'HTTP status code 200 indicates that the request was successful.'
                }
            ],
            settings: {
                shuffleQuestions: false,
                showExplanations: true,
                timeLimit: null
            },
            createdAt: new Date(),
            updatedAt: new Date()
        };

        // Mock storage manager
        const mockStorageManager = {
            getUserId: () => 'demo-user',
            storeResult: async (result) => {
                console.log('Storing result:', result);
                return result.id;
            }
        };

        let quizNavigator = null;

        // DOM elements
        const quizContainer = document.getElementById('quiz-container');
        const messagesContainer = document.getElementById('messages');
        const startButton = document.getElementById('start-quiz');
        const saveButton = document.getElementById('save-progress');
        const loadButton = document.getElementById('load-progress');
        const resetButton = document.getElementById('reset-quiz');
        const showAnswersButton = document.getElementById('show-answers');

        // Status elements
        const currentQuestionEl = document.getElementById('current-question');
        const answeredCountEl = document.getElementById('answered-count');
        const currentScoreEl = document.getElementById('current-score');
        const completionEl = document.getElementById('completion');

        // Utility functions
        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = type === 'error' ? 'error-message' : 'success-message';
            messageEl.textContent = message;
            messagesContainer.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        function updateStatus() {
            if (!quizNavigator) {
                currentQuestionEl.textContent = '-';
                answeredCountEl.textContent = '-';
                currentScoreEl.textContent = '-';
                completionEl.textContent = '-';
                return;
            }

            const state = quizNavigator.getState();
            currentQuestionEl.textContent = `${state.currentQuestionIndex + 1} / ${state.totalQuestions}`;
            answeredCountEl.textContent = `${state.answeredCount} / ${state.totalQuestions}`;
            currentScoreEl.textContent = `${state.currentScore}%`;
            completionEl.textContent = `${state.completionPercentage}%`;
        }

        function onQuizComplete(results) {
            showMessage(`Quiz completed! Final score: ${results.score}%`, 'success');
            console.log('Quiz results:', results);
            
            // Show results summary
            const summary = `
                Quiz Completed!
                Final Score: ${results.score}%
                Correct Answers: ${results.correctCount}/${results.totalQuestions}
                Time Spent: ${Math.floor(results.timeSpent / 60)}:${(results.timeSpent % 60).toString().padStart(2, '0')}
            `;
            
            quizContainer.innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <h2>ðŸŽ‰ Quiz Complete!</h2>
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <div style="font-size: 24px; font-weight: bold; color: #16a34a; margin-bottom: 10px;">
                            ${results.score}%
                        </div>
                        <div style="color: #15803d;">
                            ${results.correctCount} out of ${results.totalQuestions} correct
                        </div>
                        <div style="color: #15803d; margin-top: 10px;">
                            Time: ${Math.floor(results.timeSpent / 60)}:${(results.timeSpent % 60).toString().padStart(2, '0')}
                        </div>
                    </div>
                    <button onclick="location.reload()" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">
                        Start New Quiz
                    </button>
                </div>
            `;
            
            updateStatus();
        }

        // Event handlers
        startButton.addEventListener('click', async () => {
            try {
                quizNavigator = new QuizNavigator(sampleQuiz, mockStorageManager, onQuizComplete);
                await quizNavigator.initialize(quizContainer);
                showMessage('Quiz started successfully!', 'success');
                updateStatus();
                
                // Update status every second
                setInterval(updateStatus, 1000);
            } catch (error) {
                showMessage(`Failed to start quiz: ${error.message}`, 'error');
                console.error('Quiz start error:', error);
            }
        });

        saveButton.addEventListener('click', async () => {
            if (!quizNavigator) {
                showMessage('No active quiz to save', 'error');
                return;
            }
            
            try {
                await quizNavigator.saveProgress();
                showMessage('Progress saved successfully!', 'success');
            } catch (error) {
                showMessage(`Failed to save progress: ${error.message}`, 'error');
            }
        });

        loadButton.addEventListener('click', async () => {
            if (!quizNavigator) {
                showMessage('Start a quiz first', 'error');
                return;
            }
            
            try {
                await quizNavigator.loadProgress();
                showMessage('Progress loaded successfully!', 'success');
                updateStatus();
            } catch (error) {
                showMessage(`Failed to load progress: ${error.message}`, 'error');
            }
        });

        resetButton.addEventListener('click', () => {
            if (quizNavigator) {
                quizNavigator.destroy();
                quizNavigator = null;
            }
            quizContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #64748b;">Click "Start Quiz" to begin</div>';
            updateStatus();
            showMessage('Quiz reset', 'success');
        });

        showAnswersButton.addEventListener('click', () => {
            if (!quizNavigator) {
                showMessage('No active quiz', 'error');
                return;
            }
            
            const answers = quizNavigator.answerCollector.exportAnswers();
            console.log('Current answers:', answers);
            
            const answerSummary = Object.entries(answers.answers)
                .map(([questionId, answer]) => `${questionId}: ${JSON.stringify(answer)}`)
                .join('\n');
            
            showMessage(`Current answers logged to console. Answered: ${Object.keys(answers.answers).length}`, 'success');
        });

        // Initialize
        updateStatus();
        quizContainer.innerHTML = '<div style="padding: 40px; text-align: center; color: #64748b;">Click "Start Quiz" to begin</div>';
    </script>
</body>
</html>